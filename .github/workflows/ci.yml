name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  SQLX_OFFLINE: true
  SQLITE_DIR: ${{ github.workspace }}/.sqlite

jobs:
  # Format check (fast, runs first)
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  # Clippy lint check
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force || true

      - name: Cache SQLite installation
        id: sqlite-cache
        uses: actions/cache@v4
        with:
          key: sqlite-3500400-v2-${{ runner.os }}
          path: ${{ env.SQLITE_DIR }}

      - name: Install SQLite with sqlx features
        if: steps.sqlite-cache.outputs.cache-hit != 'true'
        run: |
          wget https://www.sqlite.org/2025/sqlite-autoconf-3500400.tar.gz
          tar xzf sqlite-autoconf-3500400.tar.gz
          cd sqlite-autoconf-3500400
          ./configure --prefix=${{ env.SQLITE_DIR }} \
              --enable-threadsafe \
              CFLAGS="-DSQLITE_ENABLE_UNLOCK_NOTIFY=1 \
                      -DSQLITE_ENABLE_COLUMN_METADATA=1 \
                      -DSQLITE_ENABLE_DBSTAT_VTAB=1 \
                      -DSQLITE_ENABLE_FTS3=1 \
                      -DSQLITE_ENABLE_FTS4=1 \
                      -DSQLITE_ENABLE_FTS5=1 \
                      -DSQLITE_ENABLE_JSON1=1 \
                      -DSQLITE_ENABLE_RTREE=1 \
                      -DSQLITE_ENABLE_GEOPOLY=1 \
                      -DSQLITE_ENABLE_MATH_FUNCTIONS=1 \
                      -DSQLITE_SOUNDEX=1 \
                      -DSQLITE_ENABLE_STAT4=1"
          make -j$(nproc)
          make install
          cd ..
          rm -rf sqlite-autoconf-3500400 sqlite-autoconf-3500400.tar.gz

      - name: Set SQLite environment
        run: |
          echo "${{ env.SQLITE_DIR }}/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=${{ env.SQLITE_DIR }}/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=${{ env.SQLITE_DIR }}/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "SQLITE3_LIB_DIR=${{ env.SQLITE_DIR }}/lib" >> $GITHUB_ENV
          echo "SQLITE3_INCLUDE_DIR=${{ env.SQLITE_DIR }}/include" >> $GITHUB_ENV

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2

      - run: cargo clippy --workspace --all-targets -- -D warnings

  # Unit tests
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force || true

      - name: Cache SQLite installation
        id: sqlite-cache
        uses: actions/cache@v4
        with:
          key: sqlite-3500400-v2-${{ runner.os }}
          path: ${{ env.SQLITE_DIR }}

      - name: Install SQLite with sqlx features
        if: steps.sqlite-cache.outputs.cache-hit != 'true'
        run: |
          wget https://www.sqlite.org/2025/sqlite-autoconf-3500400.tar.gz
          tar xzf sqlite-autoconf-3500400.tar.gz
          cd sqlite-autoconf-3500400
          ./configure --prefix=${{ env.SQLITE_DIR }} \
              --enable-threadsafe \
              CFLAGS="-DSQLITE_ENABLE_UNLOCK_NOTIFY=1 \
                      -DSQLITE_ENABLE_COLUMN_METADATA=1 \
                      -DSQLITE_ENABLE_DBSTAT_VTAB=1 \
                      -DSQLITE_ENABLE_FTS3=1 \
                      -DSQLITE_ENABLE_FTS4=1 \
                      -DSQLITE_ENABLE_FTS5=1 \
                      -DSQLITE_ENABLE_JSON1=1 \
                      -DSQLITE_ENABLE_RTREE=1 \
                      -DSQLITE_ENABLE_GEOPOLY=1 \
                      -DSQLITE_ENABLE_MATH_FUNCTIONS=1 \
                      -DSQLITE_SOUNDEX=1 \
                      -DSQLITE_ENABLE_STAT4=1"
          make -j$(nproc)
          make install
          cd ..
          rm -rf sqlite-autoconf-3500400 sqlite-autoconf-3500400.tar.gz

      - name: Set SQLite environment
        run: |
          echo "${{ env.SQLITE_DIR }}/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=${{ env.SQLITE_DIR }}/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=${{ env.SQLITE_DIR }}/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "SQLITE3_LIB_DIR=${{ env.SQLITE_DIR }}/lib" >> $GITHUB_ENV
          echo "SQLITE3_INCLUDE_DIR=${{ env.SQLITE_DIR }}/include" >> $GITHUB_ENV

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - run: cargo test --workspace --locked

  # Build check
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force || true

      - name: Cache SQLite installation
        id: sqlite-cache
        uses: actions/cache@v4
        with:
          key: sqlite-3500400-v2-${{ runner.os }}
          path: ${{ env.SQLITE_DIR }}

      - name: Install SQLite with sqlx features
        if: steps.sqlite-cache.outputs.cache-hit != 'true'
        run: |
          wget https://www.sqlite.org/2025/sqlite-autoconf-3500400.tar.gz
          tar xzf sqlite-autoconf-3500400.tar.gz
          cd sqlite-autoconf-3500400
          ./configure --prefix=${{ env.SQLITE_DIR }} \
              --enable-threadsafe \
              CFLAGS="-DSQLITE_ENABLE_UNLOCK_NOTIFY=1 \
                      -DSQLITE_ENABLE_COLUMN_METADATA=1 \
                      -DSQLITE_ENABLE_DBSTAT_VTAB=1 \
                      -DSQLITE_ENABLE_FTS3=1 \
                      -DSQLITE_ENABLE_FTS4=1 \
                      -DSQLITE_ENABLE_FTS5=1 \
                      -DSQLITE_ENABLE_JSON1=1 \
                      -DSQLITE_ENABLE_RTREE=1 \
                      -DSQLITE_ENABLE_GEOPOLY=1 \
                      -DSQLITE_ENABLE_MATH_FUNCTIONS=1 \
                      -DSQLITE_SOUNDEX=1 \
                      -DSQLITE_ENABLE_STAT4=1"
          make -j$(nproc)
          make install
          cd ..
          rm -rf sqlite-autoconf-3500400 sqlite-autoconf-3500400.tar.gz

      - name: Set SQLite environment
        run: |
          echo "${{ env.SQLITE_DIR }}/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=${{ env.SQLITE_DIR }}/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=${{ env.SQLITE_DIR }}/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "SQLITE3_LIB_DIR=${{ env.SQLITE_DIR }}/lib" >> $GITHUB_ENV
          echo "SQLITE3_INCLUDE_DIR=${{ env.SQLITE_DIR }}/include" >> $GITHUB_ENV

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Build with e2e-testing feature
        run: cargo build --workspace --release --features e2e-testing --locked

      - name: Install wasm-pack
        run: cargo install wasm-pack --locked

      - name: Build WASM module
        run: wasm-pack build crates/coordinator-wasm --target web --release --out-dir ../../crates/public_ui/pkg
        env:
          # Workaround for secp256k1-sys WASM build with clang 16+
          CFLAGS_wasm32_unknown_unknown: "-Wno-error=implicit-function-declaration"

      - name: Upload coordinator binary
        uses: actions/upload-artifact@v4
        with:
          name: coordinator-binary
          path: target/release/coordinator
          retention-days: 1

      - name: Upload UI assets
        uses: actions/upload-artifact@v4
        with:
          name: ui-assets
          path: crates/public_ui/
          retention-days: 1

  # E2E tests using Playwright with mock services
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [fmt, clippy, test, build]
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Download coordinator binary
        uses: actions/download-artifact@v4
        with:
          name: coordinator-binary
          path: ./target/release

      - name: Download UI assets
        uses: actions/download-artifact@v4
        with:
          name: ui-assets
          path: ./crates/public_ui

      - name: Make binary executable
        run: chmod +x ./target/release/coordinator

      - name: Create test credentials
        run: |
          mkdir -p creds data/e2e
          openssl ecparam -name secp256k1 -genkey -noout -out creds/coordinator_private_key.pem

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: e2e/package-lock.json

      - name: Get Playwright version
        id: playwright-version
        working-directory: e2e
        run: echo "version=$(npm ls @playwright/test --json | jq -r '.dependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install npm dependencies
        working-directory: e2e
        run: npm ci

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: e2e
        run: npx playwright install chromium --with-deps

      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        working-directory: e2e
        run: npx playwright install-deps chromium

      - name: Run Playwright tests
        working-directory: e2e
        run: npm test
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 7
