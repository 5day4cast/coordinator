name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  SQLX_OFFLINE: true

jobs:
  # Format check (fast, runs first)
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  # Clippy lint check
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force || true

      - name: Cache SQLite installation
        id: sqlite-cache
        uses: actions/cache@v4
        with:
          key: sqlite-3500400-sqlx-features-${{ runner.os }}
          path: /usr/local

      - name: Install SQLite with sqlx features
        if: steps.sqlite-cache.outputs.cache-hit != 'true'
        run: |
          wget https://www.sqlite.org/2025/sqlite-autoconf-3500400.tar.gz
          tar xzf sqlite-autoconf-3500400.tar.gz
          cd sqlite-autoconf-3500400
          ./configure --prefix=/usr/local \
              --enable-threadsafe \
              CFLAGS="-DSQLITE_ENABLE_UNLOCK_NOTIFY=1 \
                      -DSQLITE_ENABLE_COLUMN_METADATA=1 \
                      -DSQLITE_ENABLE_DBSTAT_VTAB=1 \
                      -DSQLITE_ENABLE_FTS3=1 \
                      -DSQLITE_ENABLE_FTS4=1 \
                      -DSQLITE_ENABLE_FTS5=1 \
                      -DSQLITE_ENABLE_JSON1=1 \
                      -DSQLITE_ENABLE_RTREE=1 \
                      -DSQLITE_ENABLE_GEOPOLY=1 \
                      -DSQLITE_ENABLE_MATH_FUNCTIONS=1 \
                      -DSQLITE_SOUNDEX=1 \
                      -DSQLITE_ENABLE_STAT4=1"
          make
          sudo make install
          sudo ldconfig
          cd ..
          rm -rf sqlite-autoconf-3500400 sqlite-autoconf-3500400.tar.gz

      - name: Update ldconfig after cache restore
        if: steps.sqlite-cache.outputs.cache-hit == 'true'
        run: sudo ldconfig

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2

      - run: cargo clippy --workspace --all-targets -- -D warnings

  # Unit tests
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force || true

      - name: Cache SQLite installation
        id: sqlite-cache
        uses: actions/cache@v4
        with:
          key: sqlite-3500400-sqlx-features-${{ runner.os }}
          path: /usr/local

      - name: Install SQLite with sqlx features
        if: steps.sqlite-cache.outputs.cache-hit != 'true'
        run: |
          wget https://www.sqlite.org/2025/sqlite-autoconf-3500400.tar.gz
          tar xzf sqlite-autoconf-3500400.tar.gz
          cd sqlite-autoconf-3500400
          ./configure --prefix=/usr/local \
              --enable-threadsafe \
              CFLAGS="-DSQLITE_ENABLE_UNLOCK_NOTIFY=1 \
                      -DSQLITE_ENABLE_COLUMN_METADATA=1 \
                      -DSQLITE_ENABLE_DBSTAT_VTAB=1 \
                      -DSQLITE_ENABLE_FTS3=1 \
                      -DSQLITE_ENABLE_FTS4=1 \
                      -DSQLITE_ENABLE_FTS5=1 \
                      -DSQLITE_ENABLE_JSON1=1 \
                      -DSQLITE_ENABLE_RTREE=1 \
                      -DSQLITE_ENABLE_GEOPOLY=1 \
                      -DSQLITE_ENABLE_MATH_FUNCTIONS=1 \
                      -DSQLITE_SOUNDEX=1 \
                      -DSQLITE_ENABLE_STAT4=1"
          make
          sudo make install
          sudo ldconfig
          cd ..
          rm -rf sqlite-autoconf-3500400 sqlite-autoconf-3500400.tar.gz

      - name: Update ldconfig after cache restore
        if: steps.sqlite-cache.outputs.cache-hit == 'true'
        run: sudo ldconfig

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - run: cargo test --workspace --locked

  # Build check
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force || true

      - name: Cache SQLite installation
        id: sqlite-cache
        uses: actions/cache@v4
        with:
          key: sqlite-3500400-sqlx-features-${{ runner.os }}
          path: /usr/local

      - name: Install SQLite with sqlx features
        if: steps.sqlite-cache.outputs.cache-hit != 'true'
        run: |
          wget https://www.sqlite.org/2025/sqlite-autoconf-3500400.tar.gz
          tar xzf sqlite-autoconf-3500400.tar.gz
          cd sqlite-autoconf-3500400
          ./configure --prefix=/usr/local \
              --enable-threadsafe \
              CFLAGS="-DSQLITE_ENABLE_UNLOCK_NOTIFY=1 \
                      -DSQLITE_ENABLE_COLUMN_METADATA=1 \
                      -DSQLITE_ENABLE_DBSTAT_VTAB=1 \
                      -DSQLITE_ENABLE_FTS3=1 \
                      -DSQLITE_ENABLE_FTS4=1 \
                      -DSQLITE_ENABLE_FTS5=1 \
                      -DSQLITE_ENABLE_JSON1=1 \
                      -DSQLITE_ENABLE_RTREE=1 \
                      -DSQLITE_ENABLE_GEOPOLY=1 \
                      -DSQLITE_ENABLE_MATH_FUNCTIONS=1 \
                      -DSQLITE_SOUNDEX=1 \
                      -DSQLITE_ENABLE_STAT4=1"
          make
          sudo make install
          sudo ldconfig
          cd ..
          rm -rf sqlite-autoconf-3500400 sqlite-autoconf-3500400.tar.gz

      - name: Update ldconfig after cache restore
        if: steps.sqlite-cache.outputs.cache-hit == 'true'
        run: sudo ldconfig

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - run: cargo build --workspace --release --locked

      - name: Upload coordinator binary
        uses: actions/upload-artifact@v4
        with:
          name: coordinator-binary
          path: target/release/coordinator
          retention-days: 1

  # E2E tests with full stack (Bitcoin, LND, Keymeld)
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [fmt, clippy, test, build]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force || true

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Download coordinator binary
        uses: actions/download-artifact@v4
        with:
          name: coordinator-binary
          path: target/release/

      - name: Make coordinator executable
        run: chmod +x target/release/coordinator

      - name: Start development stack
        run: |
          nix develop --command bash -c "start-all"

      - name: Wait for services
        run: |
          echo "Waiting for services to be ready..."
          sleep 10

          # Check Bitcoin
          nix develop --command bash -c "bitcoin-cli -datadir=data/bitcoin -rpcuser=coordinator -rpcpassword=coordinatorpass getblockchaininfo"

          # Check LND1
          nix develop --command bash -c "lncli --lnddir=data/lnd1 --rpcserver=127.0.0.1:10009 --network=regtest getinfo"

          # Check Keymeld
          curl -f http://127.0.0.1:8090/health || echo "Keymeld health check failed"

      - name: Run E2E tests
        run: |
          nix develop --command cargo test --test e2e -- --test-threads=1
        env:
          RUST_LOG: info

      - name: Stop development stack
        if: always()
        run: |
          nix develop --command bash -c "stop-all" || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-${{ github.run_id }}
          path: |
            logs/
            data/
          retention-days: 7
